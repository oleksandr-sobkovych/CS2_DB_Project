<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../static/css/style.css">
    </head>

    <body>
    <div class="container" id="container">
        <div class="form-container sign-in-container">
            <h1 class="heading">Створити замовлення</h1>
            <form id="search-form" class="mt-20">
                <select id="select_style" class="custom-select">
                    <option selected="selected" disabled>Стиль повідомлення</option>
                </select>
                <select id="select_team" class="custom-select">
                    <option selected="selected" disabled>Команда авторів</option>
                </select>
                <select id="select_media" class="custom-select">
                    <option selected="selected" disabled>Соцмережа</option>
                </select>

                <button type="button" class="custom-btn" id="create">Створити замовлення</button>
                <p id="message"></p>
                <a href="/customer_account" class="mt-20">Повернутися в аккаунт</a>
            </form>
        </div>
    </div>

    <script>

    document.addEventListener("DOMContentLoaded", async function() {
        // Add styles
        let x = document.getElementById("select_style");
        let response = await fetch('/all_styles');
        let data = await response.json();

        let promise = new Promise((resolve, reject) => {
            resolve(data)
        });

        data["styles"].forEach(style => {
            var option = document.createElement("option");
            option.text = style.name;
            option.setAttribute('id', style.style_id);
            x.add(option);
        });

        // Add team
        x = document.getElementById("select_team");
        response = await fetch('/all_teams');
        data = await response.json();

        promise = new Promise((resolve, reject) => {
            resolve(data)
        });

        data["teams"].forEach(team => {
            var option = document.createElement("option");
            option.text = team.name;
            option.setAttribute('id', team.team_id);
            x.add(option);
        });

        // Add social media
        const customer_id = localStorage.getItem('customer_id');
        x = document.getElementById("select_media");
        response = await fetch('/customer_media?customer_id=' + customer_id);
        data = await response.json();

        promise = new Promise((resolve, reject) => {
            resolve(data)
        });

        data["media"].forEach(media => {
            var option = document.createElement("option");
            option.text = media.name;
            option.setAttribute('id', media.media_id);
            x.add(option);
        });
    });

    document.getElementById('create').addEventListener('click', async function(evt){
        evt.preventDefault();
        const author_id = localStorage.getItem('author_id');
        const date_from = document.getElementById('date_from').value;
        const date_to = document.getElementById('date_to').value;
        const amount = document.getElementById('amount').value;
        const select = document.getElementById('select');
        const style_id = select.options[select.selectedIndex].getAttribute('id');
        document.getElementById('container').classList = 'container disabled';

        let response = await fetch('/multiple_days_discount', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({author_id, date_from, date_to, amount, style_id})
        });
        response = await response.json();
        console.log(response);
        if (response.status === 'ok') {
            alert('Багатоденну знижку успішно створено!');
            window.location = 'author_account';
        } else {
            document.getElementById('container').classList = 'container';
            document.getElementById('message').innerText = 'Error message: ' + response.reason;
        }
    });

    </script>
    </body>
</html>
